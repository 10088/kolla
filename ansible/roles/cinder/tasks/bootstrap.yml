---
- name: Creating Cinder database
  command: docker exec -t kolla_ansible /usr/bin/ansible localhost
    -m mysql_db
    -a "login_host='{{ database_address }}'
        login_user='{{ database_user }}'
        login_password='{{ database_password }}'
        name='{{ cinder_database_name }}'"
  register: database
  changed_when: "{{ database.stdout.find('localhost | SUCCESS => ') != -1 and (database.stdout.split('localhost | SUCCESS => ')[1]|from_json).changed }}"
  failed_when: database.stdout.split()[2] != 'SUCCESS'
  run_once: True
  delegate_to: "{{ groups['cinder-api'][0] }}"

- name: Creating Cinder database user and setting permissions
  command: docker exec -t kolla_ansible /usr/bin/ansible localhost
    -m mysql_user
    -a "login_host='{{ database_address }}'
        login_user='{{ database_user }}'
        login_password='{{ database_password }}'
        name='{{ cinder_database_name }}'
        password='{{ cinder_database_password }}'
        host='%'
        priv='{{ cinder_database_name }}.*:ALL'
        append_privs='yes'"
  register: database_user_create
  changed_when: "{{ database_user_create.stdout.find('localhost | SUCCESS => ') != -1 and (database_user_create.stdout.split('localhost | SUCCESS => ')[1]|from_json).changed }}"
  failed_when: database_user_create.stdout.split()[2] != 'SUCCESS'
  run_once: True
  delegate_to: "{{ groups['cinder-api'][0] }}"

- name: Starting Cinder data container
  docker:
    tty: True
    net: host
    pull: "{{ docker_pull_policy }}"
    restart_policy: "{{ docker_restart_policy }}"
    restart_policy_retry: "{{ docker_restart_policy_retry }}"
    state: reloaded
    registry: "{{ docker_registry }}"
    username: "{{ docker_registry_username }}"
    password: "{{ docker_registry_password }}"
    insecure_registry: "{{ docker_insecure_registry }}"
    name: cinder_data
    image: "{{ cinder_data_image_full }}"
    volumes: "/var/lib/cinder/"

- name: Starting Cinder bootstrap container
  docker:
    tty: True
    detach: False
    net: host
    pull: "{{ docker_pull_policy }}"
    restart_policy: "no"
    state: reloaded
    registry: "{{ docker_registry }}"
    username: "{{ docker_registry_username }}"
    password: "{{ docker_registry_password }}"
    insecure_registry: "{{ docker_insecure_registry }}"
    name: bootstrap_cinder
    image: "{{ cinder_api_image_full }}"
    volumes: "{{ node_config_directory }}/cinder-api/:{{ container_config_directory }}/:ro"
    volumes_from:
     - cinder_data
    env:
      KOLLA_BOOTSTRAP:
      KOLLA_CONFIG_STRATEGY: "{{ config_strategy }}"
  run_once: True
  delegate_to: "{{ groups['cinder-api'][0] }}"
  when: database.stdout.find('localhost | SUCCESS => ') != -1 and (database.stdout.split('localhost | SUCCESS => ')[1]|from_json).changed

# https://github.com/ansible/ansible-modules-core/pull/1031
- name: Waiting for bootstrap container to exit
  command: docker wait bootstrap_cinder
  failed_when: bootstrap_result.stdout != "0"
  register: bootstrap_result
  run_once: True
  delegate_to: "{{ groups['cinder-api'][0] }}"
  when: database.stdout.find('localhost | SUCCESS => ') != -1 and (database.stdout.split('localhost | SUCCESS => ')[1]|from_json).changed

- name: Cleaning up Cinder bootstrap container
  docker:
    tty: True
    name: bootstrap_cinder
    image: "{{ cinder_api_image_full }}"
    state: absent
  delegate_to: "{{ groups['cinder-api'][0] }}"
  when: database.stdout.find('localhost | SUCCESS => ') != -1 and (database.stdout.split('localhost | SUCCESS => ')[1]|from_json).changed
