---
- hosts: all
  tasks:
    - name: Login to Dockerhub
      command: "docker login -u {{ kolla_dockerhub_creds.user }} -p {{ kolla_dockerhub_creds.password }}"
      no_log: true

    - name: Ensure ~/.docker exists
      file:
        path: ~/.docker
        state: directory
        mode: 0777

    - name: Enable experimental features in Docker so we can use 'docker manifest'
      copy:
        content: '{ "experimental": "enabled" }'
        dest: ~/.docker/config.json

    - name: Define image tag
      set_fact:
        image_tag: zuul.branch | regex_replace('^stable/', '')

    - name: Create multiarch images
      command: "TAG={{ image_tag }} NAMESPACE=kolla DISTRO={{ base_distro }} TYPE={{ install_type }} tools/create-multiarch-images.sh"
